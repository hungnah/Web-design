{% extends 'base.html' %}

{% block title %}Voucher của tôi - Vietnam-Japan Connect{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% csrf_token %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-ticket-alt"></i> Voucher của tôi</h2>
                <div>
                    <a href="/auth/point-exchange/" class="btn btn-primary me-2">
                        <i class="fas fa-exchange-alt"></i> Đổi điểm mới
                    </a>
                    <a href="/auth/voucher-history/" class="btn btn-info me-2">
                        <i class="fas fa-history"></i> Lịch sử voucher
                    </a>
                    <a href="/auth/dashboard/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại Dashboard
                    </a>
                </div>
            </div>

            <!-- Current Points Display -->
            <div class="alert alert-info text-center mb-4">
                <h5 class="mb-2">Điểm hiện tại của bạn</h5>
                <div class="display-5 text-primary">{{ user_points }}</div>
                <small class="text-muted">がんばりポイント</small>
            </div>

            {% if vouchers %}
                <!-- Vouchers Grid -->
                <div class="row">
                    {% for voucher in vouchers %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 {% if voucher.status == 'active' %}border-success{% elif voucher.status == 'used' %}border-secondary{% else %}border-warning{% endif %}">
                                <div class="card-header {% if voucher.status == 'active' %}bg-success text-white{% elif voucher.status == 'used' %}bg-secondary text-white{% else %}bg-warning text-dark{% endif %}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-{% if voucher.voucher_type == 'coffee' %}coffee{% elif voucher.voucher_type == 'restaurant' %}utensils{% elif voucher.voucher_type == 'shopping' %}shopping-bag{% elif voucher.voucher_type == 'transport' %}bus{% else %}film{% endif %}"></i>
                                            {{ voucher.get_voucher_type_display }}
                                        </h6>
                                        <span class="badge {% if voucher.status == 'active' %}bg-light text-success{% elif voucher.status == 'used' %}bg-light text-secondary{% else %}bg-light text-warning{% endif %}">
                                            {{ voucher.get_status_display }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <div class="display-6 text-primary">{{ voucher.discount_percentage }}%</div>
                                        <small class="text-muted">Giảm giá</small>
                                    </div>
                                    
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-tag text-primary me-2"></i>
                                            <strong>Loại:</strong> {{ voucher.get_voucher_type_display }}
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-coins text-warning me-2"></i>
                                            <strong>Điểm đã đổi:</strong> {{ voucher.points_required }}
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-calendar text-success me-2"></i>
                                            <strong>Tạo ngày:</strong> {{ voucher.created_at|date:"d/m/Y" }}
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-clock text-info me-2"></i>
                                            <strong>Hiệu lực đến:</strong> {{ voucher.valid_until|date:"d/m/Y" }}
                                        </li>
                                        {% if voucher.used_at %}
                                            <li class="mb-2">
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                                <strong>Sử dụng ngày:</strong> {{ voucher.used_at|date:"d/m/Y" }}
                                            </li>
                                        {% endif %}
                                    </ul>
                                    
                                    <div class="mt-3">
                                        <p class="card-text small text-muted">{{ voucher.description }}</p>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    {% if voucher.status == 'active' %}
                                        <div class="d-grid">
                                            <button class="btn btn-success btn-sm" onclick="useVoucher({{ voucher.id }})" type="button">
                                                <i class="fas fa-check"></i> Sử dụng voucher
                                            </button>
                                        </div>
                                    {% elif voucher.status == 'used' %}
                                        <div class="text-center">
                                            <span class="badge bg-secondary">Đã sử dụng</span>
                                        </div>
                                    {% else %}
                                        <div class="text-center">
                                            <span class="badge bg-warning text-dark">Hết hạn</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Voucher Statistics -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-success">{{ active_vouchers_count }}</h5>
                                <small class="text-muted">Voucher còn hiệu lực</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-secondary">{{ used_vouchers_count }}</h5>
                                <small class="text-muted">Voucher đã sử dụng</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-warning">{{ expired_vouchers_count }}</h5>
                                <small class="text-muted">Voucher hết hạn</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="text-info">{{ total_vouchers }}</h5>
                                <small class="text-muted">Tổng số voucher</small>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- No Active Vouchers Message -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-ticket-alt fa-5x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">
                        {% if total_vouchers > 0 %}
                            Bạn không có voucher còn hiệu lực nào
                        {% else %}
                            Bạn chưa có voucher nào
                        {% endif %}
                    </h4>
                    <p class="text-muted mb-4">
                        {% if total_vouchers > 0 %}
                            Tất cả voucher của bạn đã được sử dụng hoặc hết hạn. Hãy đổi điểm mới!
                        {% else %}
                            Hãy đổi điểm がんばりポイント để nhận voucher giảm giá!
                        {% endif %}
                    </p>
                    <a href="/auth/point-exchange/" class="btn btn-primary btn-lg">
                        <i class="fas fa-exchange-alt"></i> Đổi điểm ngay
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>


<script>
let currentVoucherId = null;

// Get CSRF token safely
function getCSRFToken() {
    try {
        // First try to get token from the hidden input
        let token = document.querySelector('[name=csrfmiddlewaretoken]');
        
        if (!token) {
            console.log('CSRF token element not found, creating one...');
            // Create a hidden input for CSRF token if it doesn't exist
            const form = document.createElement('form');
            form.style.display = 'none';
            form.innerHTML = '{% csrf_token %}';
            document.body.appendChild(form);
            
            // Get the newly created token
            token = document.querySelector('[name=csrfmiddlewaretoken]');
        }
        
        if (token && token.value) {
            console.log('CSRF token found:', token.value.substring(0, 20) + '...');
            return token.value;
        }
        
        // Fallback: try to get from meta tag
        const metaToken = document.querySelector('meta[name=csrf-token]');
        if (metaToken && metaToken.content) {
            console.log('CSRF token found in meta tag');
            return metaToken.content;
        }
        
        // Fallback: try to get from cookie
        const cookieToken = getCookie('csrftoken');
        if (cookieToken) {
            console.log('CSRF token found in cookie');
            return cookieToken;
        }
        
        console.error('No CSRF token found from any source');
        return '';
        
    } catch (error) {
        console.error('Error getting CSRF token:', error);
        return '';
    }
}

// Helper function to get cookie value
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add event listener when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, setting up event listeners...');
    
    // Test if we can find voucher buttons
    const voucherButtons = document.querySelectorAll('button[onclick*="useVoucher"]');
    console.log('Found voucher buttons:', voucherButtons.length);
    
    // Add click event listeners as backup
    voucherButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            console.log('Button clicked via event listener');
            const voucherId = this.getAttribute('onclick').match(/useVoucher\((\d+)\)/)?.[1];
            if (voucherId) {
                console.log('Voucher ID from event listener:', voucherId);
                useVoucher(voucherId);
            }
        });
    });
    
    // Add global error handler
    window.addEventListener('error', function(e) {
        console.error('Global error caught:', e.error);
        showErrorMessage('Có lỗi JavaScript xảy ra. Vui lòng tải lại trang.');
    });
    
    // Add unhandled rejection handler
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
        showErrorMessage('Có lỗi xử lý yêu cầu. Vui lòng thử lại.');
        e.preventDefault();
    });
});

function useVoucher(voucherId) {
    try {
        console.log('useVoucher called with ID:', voucherId);
        currentVoucherId = voucherId;
        
        // Get CSRF token safely
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            console.error('CSRF token not available');
            showErrorMessage('Lỗi bảo mật: Không thể xác thực yêu cầu. Vui lòng tải lại trang hoặc đăng nhập lại.');
            
            // Try to refresh the page automatically after a delay
            setTimeout(() => {
                if (confirm('Bạn có muốn tải lại trang để khắc phục lỗi không?')) {
                    window.location.reload();
                }
            }, 2000);
            return;
        }
        
        // Show loading state on the button
        const voucherButton = document.querySelector(`[onclick="useVoucher(${voucherId})"]`);
        if (voucherButton) {
            const originalText = voucherButton.innerHTML;
            voucherButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';
            voucherButton.disabled = true;
            
            // Make the request immediately
            fetch(`/auth/use-voucher/${voucherId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.success) {
                    // Show success message
                    showSuccessMessage('Voucher đã được sử dụng thành công!');
                    
                    // Remove the voucher card from the page immediately
                    removeVoucherFromPage(voucherId);
                    
                    // Update statistics
                    updateVoucherStatistics();
                    
                    // Check if no more vouchers
                    checkNoVouchersMessage();
                } else {
                    showErrorMessage(data.message || 'Có lỗi xảy ra khi sử dụng voucher');
                    // Reset button state on error
                    voucherButton.innerHTML = originalText;
                    voucherButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                let errorMessage = 'Có lỗi xảy ra khi sử dụng voucher';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Không thể kết nối đến server. Vui lòng kiểm tra kết nối mạng.';
                } else if (error.message.includes('HTTP error')) {
                    if (error.message.includes('403')) {
                        errorMessage = 'Lỗi quyền truy cập. Vui lòng đăng nhập lại.';
                    } else if (error.message.includes('500')) {
                        errorMessage = 'Lỗi server. Vui lòng thử lại sau.';
                    } else {
                        errorMessage = 'Lỗi server. Vui lòng thử lại sau.';
                    }
                } else {
                    errorMessage += ': ' + error.message;
                }
                
                showErrorMessage(errorMessage);
                
                // Reset button state on error
                voucherButton.innerHTML = originalText;
                voucherButton.disabled = false;
            });
        } else {
            showErrorMessage('Không thể tìm thấy nút voucher. Vui lòng thử lại.');
        }
        
    } catch (error) {
        console.error('Error in useVoucher:', error);
        showErrorMessage('Có lỗi xảy ra khi sử dụng voucher. Vui lòng thử lại.');
    }
}

function removeVoucherFromPage(voucherId) {
    try {
        console.log('Removing voucher from page:', voucherId);
        
        // Find and remove the voucher card
        const voucherButton = document.querySelector(`[onclick="useVoucher(${voucherId})"]`);
        if (voucherButton) {
            const voucherCard = voucherButton.closest('.col-md-6.col-lg-4.mb-4');
            if (voucherCard) {
                // Add fade out effect
                voucherCard.style.transition = 'opacity 0.5s ease-out';
                voucherCard.style.opacity = '0';
                
                // Remove after animation
                setTimeout(() => {
                    if (voucherCard.parentNode) {
                        voucherCard.remove();
                        console.log('Voucher card removed successfully');
                    }
                }, 500);
            } else {
                console.error('Voucher card container not found');
            }
        } else {
            console.error('Voucher button not found for ID:', voucherId);
        }
    } catch (error) {
        console.error('Error removing voucher from page:', error);
        // Fallback: force remove by class
        const allVoucherCards = document.querySelectorAll('.col-md-6.col-lg-4.mb-4');
        allVoucherCards.forEach(card => {
            if (card.textContent.includes(voucherId.toString())) {
                card.remove();
            }
        });
    }
}

function updateVoucherStatistics() {
    try {
        console.log('Updating voucher statistics...');
        
        // Update active vouchers count
        const activeCountElement = document.querySelector('.col-md-3:nth-child(1) h5');
        if (activeCountElement) {
            const currentCount = parseInt(activeCountElement.textContent) || 0;
            const newCount = Math.max(0, currentCount - 1);
            activeCountElement.textContent = newCount;
            console.log('Active vouchers updated:', currentCount, '->', newCount);
        } else {
            console.error('Active vouchers count element not found');
        }
        
        // Update used vouchers count
        const usedCountElement = document.querySelector('.col-md-3:nth-child(2) h5');
        if (usedCountElement) {
            const currentUsed = parseInt(usedCountElement.textContent) || 0;
            usedCountElement.textContent = currentUsed + 1;
            console.log('Used vouchers updated:', currentUsed, '->', currentUsed + 1);
        }
        
        // Total vouchers count should remain the same
        console.log('Statistics updated successfully');
    } catch (error) {
        console.error('Error updating voucher statistics:', error);
    }
}

function checkNoVouchersMessage() {
    // Check if there are no more active vouchers
    const activeVouchers = document.querySelectorAll('.col-md-6.col-lg-4.mb-4');
    if (activeVouchers.length === 0) {
        // Show no vouchers message
        const vouchersGrid = document.querySelector('.row');
        if (vouchersGrid) {
            const noVouchersMessage = `
                <div class="col-12">
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-ticket-alt fa-5x text-muted"></i>
                        </div>
                        <h4 class="text-muted mb-3">Bạn không có voucher còn hiệu lực nào</h4>
                        <p class="text-muted mb-4">Tất cả voucher của bạn đã được sử dụng hoặc hết hạn. Hãy đổi điểm mới!</p>
                        <a href="/auth/point-exchange/" class="btn btn-primary btn-lg">
                            <i class="fas fa-exchange-alt"></i> Đổi điểm ngay
                        </a>
                    </div>
                </div>
            `;
            vouchersGrid.innerHTML = noVouchersMessage;
        }
    }
}

function showSuccessMessage(message) {
    try {
        // Create success toast
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Try to show toast with Bootstrap
        try {
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        } catch (error) {
            console.error('Bootstrap toast error, showing manually:', error);
            // Fallback: show manually
            toast.style.display = 'block';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        // Remove toast after it's hidden or after timeout
        toast.addEventListener('hidden.bs.toast', () => {
            if (toast.parentNode) {
                toast.remove();
            }
        });
        
        // Auto-remove after 5 seconds as backup
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
        
    } catch (error) {
        console.error('Error showing success message:', error);
        // Fallback: simple alert
        alert('✓ ' + message);
    }
}

function showErrorMessage(message) {
    // Create error toast
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-circle me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

function copyVoucherCode() {
    // This function is no longer needed
    console.log('copyVoucherCode function removed');
}

// Function to reset confirm button to original state
function resetConfirmButton() {
    // This function is no longer needed
    console.log('resetConfirmButton function removed');
}

// Function to check and fix stuck button
function checkAndFixStuckButton() {
    // This function is no longer needed
    console.log('checkAndFixStuckButton function removed');
}

// Auto-check for stuck button every 2 seconds
// setInterval(checkAndFixStuckButton, 2000);

// Function to ensure CSRF token exists
function ensureCSRFToken() {
    // This function is no longer needed
    console.log('ensureCSRFToken function removed');
}

// Function to force reset everything
function forceResetAll() {
    // This function is no longer needed
    console.log('forceResetAll function removed');
}

// Function to test CSRF token
function testCSRFToken() {
    // This function is no longer needed
    console.log('testCSRFToken function removed');
}

// Function to fix frozen screen
function fixFrozenScreen() {
    // This function is no longer needed
    console.log('fixFrozenScreen function removed');
}

// Function to handle network timeouts
function handleNetworkTimeout() {
    // This function is no longer needed
    console.log('handleNetworkTimeout function removed');
}

// Function to check if page is responsive
function checkPageResponsiveness() {
    // This function is no longer needed
    console.log('checkPageResponsiveness function removed');
}

// Add periodic responsiveness check
// setInterval(checkPageResponsiveness, 30000);

// Function to force refresh page if everything else fails
function forceRefreshPage() {
    // This function is no longer needed
    console.log('forceRefreshPage function removed');
}

// Function to add emergency controls
function addEmergencyControls() {
    // This function is no longer needed
    console.log('addEmergencyControls function removed');
}

</script>
{% endblock %}
